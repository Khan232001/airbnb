<% layout('listings/layouts/boilerplate') %>

<!-- ‚úÖ Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container mt-4">
  <h3>Listing Details</h3>

  <!-- üì∏ Listing Card -->
  <div class="card mb-4 shadow-sm <%= listing.isDeleted ? 'deleted-listing' : '' %>">
    <img
      src="<%= listing.image?.url || '/images/placeholder.jpg' %>"
      class="card-img-top rounded-top"
      alt="<%= listing.title %>"
      style="height: 25rem; object-fit: cover;"
    />
    <div class="card-body">
      <h4 class="card-title mb-2"><%= listing.title %></h4>
      <p class="card-text"><%= listing.description %></p>
      <p><b>$<%= listing.price.toLocaleString("en-US") %> / night</b></p>
      <p><%= listing.location %>, <%= listing.country %></p>

      <% if (listing.isDeleted) { %>
        <!-- ‚ö†Ô∏è Deleted Message -->
        <div class="alert alert-warning mb-3">
          <strong>This listing is deleted.</strong> You can restore it below.
        </div>

        <!-- ‚úÖ Restore Button -->
        <form action="/listings/<%= listing._id %>/restore" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-success">
            <i class="bi bi-arrow-clockwise"></i> Restore Listing
          </button>
        </form>
      <% } else { %>
        <!-- ‚úÖ Edit & Delete Buttons -->
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary">
          <i class="bi bi-pencil-square"></i> Edit
        </a>
        <form
          action="/listings/<%= listing._id %>?_method=DELETE"
          method="POST"
          style="display: inline;"
          onsubmit="return confirm('Are you sure you want to delete this listing?');"
        >
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>
      <% } %>
    </div>
  </div>

  <% if (!listing.isDeleted) { %>
    <!-- üí≥ Booking Form -->
    <div class="card mb-4 border-success shadow-sm">
      <div class="card-body">
        <h4 class="text-success mb-3">Book This Stay</h4>
        <% if (currentUser) { %>
          <form action="/bookings/<%= listing._id %>/book" method="POST">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="checkIn" class="form-label">Check-In</label>
                <input type="date" id="checkIn" name="checkIn" class="form-control" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="checkOut" class="form-label">Check-Out</label>
                <input type="date" id="checkOut" name="checkOut" class="form-control" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="guests" class="form-label">Guests</label>
                <input type="number" id="guests" name="guests" class="form-control" min="1" max="10" required>
              </div>
            </div>
            <button type="submit" class="btn btn-success w-100">Confirm Booking</button>
          </form>
        <% } else { %>
          <p class="text-muted">
            Please <a href="/login" class="text-decoration-none">login</a> to make a booking.
          </p>
        <% } %>
      </div>
    </div>

    <!-- ‚≠ê Leave a Review Form -->
    <div class="col-8 offset-2">
      <h4>Leave a Review</h4>
      <form action="/listings/<%= listing._id %>/reviews" method="POST" class="mb-4">
        <div class="star-rating mb-3">
          <% for (let i = 5; i >= 1; i--) { %>
            <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>">
            <label for="star<%= i %>" class="bi bi-star-fill"></label>
          <% } %>
        </div>

        <div class="mb-3">
          <label for="comment">Comment:</label>
          <textarea
            name="review[comment]"
            id="comment"
            cols="30"
            rows="4"
            class="form-control"
            required
          ></textarea>
        </div>

        <button type="submit" class="btn btn-success">Submit Review</button>
      </form>

      <!-- ‚≠ê Reviews Section -->
      <div class="mt-4">
        <h4>Reviews</h4>
        <% if (listing.reviews.length === 0) { %>
          <p class="text-muted">No reviews yet.</p>
        <% } else { %>
          <ul class="list-group">
            <% listing.reviews.forEach(function(review) { %>
              <li class="list-group-item">
                <div class="readonly-stars mb-1">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <% if (i <= review.rating) { %>
                      <i class="bi bi-star-fill text-warning"></i>
                    <% } else { %>
                      <i class="bi bi-star text-muted"></i>
                    <% } %>
                  <% } %>
                </div>

                <p class="mb-1"><%= review.comment %></p>
                <small class="text-muted">
                  Posted on 
                  <%= review.createdAt ? new Date(review.createdAt).toLocaleDateString() : 'Unknown date' %>
                </small>

                <form class="mt-2" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                  <button class="btn btn-sm btn-outline-danger">Delete Review</button>
                </form>
              </li>
            <% }); %>
          </ul>
          <h5 class="mt-3 text-secondary">Total Reviews: <%= listing.reviews.length %></h5>
        <% } %>
      </div>
    </div>
  <% } else { %>
    <div class="alert alert-warning text-center mt-4 shadow-sm">
      <h5>This listing is currently deleted.</h5>
      <p>You can restore it using the button above.</p>
    </div>
  <% } %>

  <div class="col-8 offset-3 mb-3">
    <h3>Location</h3>
    <div id="map" style="height: 400px;"></div>
  </div>

  <!-- üìç Map Script -->
  <script>
    mapboxgl.accessToken = "<%= mapToken %>";
    const map = new mapboxgl.Map({
      container: 'map',
      center: [-96.7970, 32.7767],
      zoom: 9
    });

    // ‚ú® Optional restore button animation
    const restoreBtn = document.querySelector('form[action*="/restore"] button');
    if (restoreBtn) {
      restoreBtn.addEventListener("click", () => {
        restoreBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Restoring...';
      });
    }
  </script>
</div>

<!-- ‚≠ê Styles -->
<style>
  /* üî∏ Dim deleted listings */
  .deleted-listing {
    opacity: 0.6;
    filter: grayscale(80%);
  }

  /* ‚≠ê Interactive Rating Stars */
  .star-rating {
    direction: rtl;
    display: inline-block;
    cursor: pointer;
  }

  .star-rating input {
    display: none;
  }

  .star-rating label {
    color: #ccc;
    font-size: 2rem;
    padding: 0 4px;
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .star-rating label:hover,
  .star-rating label:hover ~ label,
  .star-rating input:checked ~ label {
    color: #ffc107; /* ‚úÖ Gold yellow for hover/clicked stars */
  }

  .star-rating label.active {
    transform: scale(1.3);
  }

  /* Read-only stars (displayed reviews) */
  .readonly-stars i {
    font-size: 1.4rem;
    margin-right: 2px;
  }
</style>

<!-- ‚≠ê Script -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Select all inputs and labels for rating stars
    const starInputs = document.querySelectorAll(".star-rating input");
    const starLabels = document.querySelectorAll(".star-rating label");
    const starContainer = document.querySelector(".star-rating");

    if (!starContainer) return; // safety check

    // When clicking a star ‚Üí highlight properly
    starLabels.forEach((label) => {
      label.addEventListener("click", function () {
        // Remove active class from all stars
        starLabels.forEach((l) => l.classList.remove("active"));
        this.classList.add("active");

        // Little bounce animation
        setTimeout(() => this.classList.remove("active"), 150);
      });
    });

    // When clicking anywhere outside ‚Üí reset stars
    document.addEventListener("click", function (e) {
      if (!starContainer.contains(e.target)) {
        starInputs.forEach((input) => (input.checked = false)); // Uncheck all
      }
    });
  });
</script>

